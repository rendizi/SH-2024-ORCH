import axios from "axios";

export const fetchLatest = async () => {
    try{
        const response = await axios.post<SploitusResponse>(
            "https://sploitus.com/search",
            {"type":"exploits","sort":"default","query":"POC","title":false,"offset":0}
          );
          

        const technologies = await determineTechnology(response.data)
        console.log(technologies)
    }catch(err){
        console.error(err)
    }
}

const determineTechnology = async (data: SploitusResponse) => {
    const messages = [
        {
            "role": "system",
            "content": "You are an expert in cybersecurity and software technologies. Your task is to analyze a list of exploits and identify the specific technologies, software, or systems they are associated with based on their descriptions. For each exploit, provide a JSON object containing the exploit ID and a list of associated technologies. Return the output as a list of objects, where each object follows this format: {\"id\": \"ExploitID\", \"technologies\": [\"Technology1\", \"Technology2\"]}. Ensure your associations are precise and based solely on the exploit description."
        },
        {
            "role": "user",
            "content": JSON.stringify(data.exploits)
        }       
    ]
    try{
        const response = await axios.post(process.env.AZURE_URL || "", 
            {
                messages,
                "max_tokens":500,
                "temperature":0.5
            },
            {
                headers: {
                    'api-key':process.env.AZURE_KEY || ""
                }
            })
        return response.data.choices[0].message.content 
    }catch(err){
        console.error(err)
    }
}

export interface SploitusResponse{
    exploits_total: number 
    exploits: {
        title: string 
        score: number 
        href: string 
        type: string 
        published: string 
        id: string 
        source: string 
        language: string 
    }[]
}